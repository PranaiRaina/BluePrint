from RAG_PIPELINE.src.graph import app_graph
from typing import Optional

async def perform_rag_search(query: str, user_id: str = "fallback-user-id") -> str:
    """
    Search connected documents for answers using the RAG pipeline.
    
    Args:
        query: The user's question about the documents (e.g., "Summarize the invoice").
        user_id: The unique ID of the user to scope the search to.
        
    Returns:
        The text answer generated by the document analysis system.
    """
    try:
        # Invoke the LangGraph pipeline
        # The graph now expects user_id for filtering
        result = await app_graph.ainvoke({"question": query, "user_id": user_id})
        
        # Extract the generation
        answer = result.get("generation")
        if not answer:
            return "Analysis complete, but no direct answer was generated."
            
        return answer
    except Exception as e:
        return f"Error performing RAG search: {str(e)}"


async def ask_stock_analyst(query: str) -> str:
    """
    Delegate a stock analysis question to the Stock Analysis Multi-Agent System.
    Use this for any question about stock prices, market trends, portfolio optimization,
    or investment recommendations for specific tickers (e.g., AAPL, TSLA, NVDA).
    
    Args:
        query: The user's question about stocks or market analysis.
        
    Returns:
        A comprehensive analysis and recommendation from the stock analysis team.
    """
    try:
        from StockAgents.services.agent_engine import agent_engine
        from StockAgents.services.llm_service import llm_service
        
        # Extract user's portfolio context from query (e.g., "I have 50 shares of AAPL")
        user_context = await llm_service.extract_structured_data(query)
        print(f"[ask_stock_analyst] Extracted user_context: {user_context}")
        
        # Run the multi-agent workflow with the extracted context
        result = await agent_engine.run_workflow(query, user_context=user_context)
        
        # Return the synthesized recommendation
        return result.get("recommendation", "Stock analysis completed, but no recommendation was generated.")
    except Exception as e:
        return f"Error performing stock analysis: {str(e)}"

